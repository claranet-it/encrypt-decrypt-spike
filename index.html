<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Encrypt / Decrypt Spike</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
</head>

<body class="p-4 bg-white dark:bg-gray-800 text-gray-900 dark:text-white">
    <form novalidate onsubmit="return false">
        <h1 class="text-xl mb-2">Encrypt / Decrypt</h1>

        <label for="private-key">
            <span class="text-sm font-medium text-gray-700 dark:text-gray-200">Private Key</span>
        
            <input
                type="file"
                id="private-key"
                class="mt-0.5 w-full rounded border-gray-300 shadow-sm sm:text-sm dark:border-gray-600 dark:bg-gray-900 dark:text-white p-2 rounded border-1"
            />
        </label>

        <br><br>
    
        <label for="symmetric-key">
            <span class="text-sm font-medium text-gray-700 dark:text-gray-200">Symmetric Key (Encrypted)</span>
        
            <div class="flex">
                <input
                    type="text"
                    id="symmetric-key"
                    value="op4RUkSHv3CZyL+KbpIlutSNmkcSNfXYRiscQkcZZYv8UdUdgLUT/2XRKN60tM/lPrMJYt7m1kxG14YGxeLWp5LO5J6Ikz3ogkF6La60DjpJ0Qo9+4SP1jb1hmUNbek16qDOrSYkfSlbPpoM7CTCdxSiaCAhBrbKq8J+szBdrIh0+j04VpglFI5z7soJe5mSSBT2Ci+RB8RT3ZRRRXZ5AgRqRl6dY17XqMhHvDP1fOHX5PhKwJdxFx85pulPh+JIRxbTL1s2mljPxYbYWKj06rI7HBAurDXkEgtE+aBo2eA0ApLqAqCe3/rCVvPGzjtnZaB8JX7rERDlHWsVm8+Xzw=="
                    class="mt-0.5 w-full rounded border-gray-300 shadow-sm sm:text-sm dark:border-gray-600 dark:bg-gray-900 dark:text-white p-2 rounded border-1"
                />
            </div>
        </label>

        <br>
    
        <label for="dataToEncrypt">
            <span class="text-sm font-medium text-gray-700 dark:text-gray-200">Data</span>
        
            <div class="flex">
                <input
                    type="text"
                    id="dataToEncrypt"
                    class="mt-0.5 w-full rounded border-gray-300 shadow-sm sm:text-sm dark:border-gray-600 dark:bg-gray-900 dark:text-white p-2 rounded border-1"
                />
    
                <button
                    id="decrypt-action"
                    class="inline-block rounded-sm border border-indigo-600 bg-indigo-600 px-12 py-3 text-sm font-medium text-white hover:bg-transparent hover:text-indigo-600 focus:ring-3 focus:outline-hidden"
                    type="submit"
                >
                    Decrypt
                </button>
            </div>
        </label>
    
        <br><br>
        <h2 class="text-xl mb-4">Results</h2>
    
        <div class="flow-root">
            <dl class="-my-3 divide-y divide-gray-200 text-sm dark:divide-gray-700">
              <div class="grid grid-cols-1 gap-1 py-3 sm:grid-cols-3 sm:gap-4">
                <dt class="font-medium text-gray-900 dark:text-white">Encrypted:</dt>
          
                <dd class="text-gray-700 sm:col-span-2 dark:text-gray-200" id="encrypted-value"></dd>
              </div>
          
              <div class="grid grid-cols-1 gap-1 py-3 sm:grid-cols-3 sm:gap-4">
                <dt class="font-medium text-gray-900 dark:text-white">Decrypted:</dt>
          
                <dd class="text-gray-700 sm:col-span-2 dark:text-gray-200" id="decrypted-value"></dd>
              </div>
            </dl>
          </div>
    </form>
</body>
<script src="https://cdn.jsdelivr.net/npm/idb@8/build/umd.js"></script>
<script type="text/javascript">
    let _globalAESKey = undefined;

    async function decryptGlobalAESKey(encryptedAESKey) {
        _globalAESKey = await decryptedAESKey(encryptedAESKey)
    }

    (async () => {
        await decryptGlobalAESKey(document.getElementById("symmetric-key").value)
    })()

    document.getElementById("private-key").addEventListener("change", async (event) => {
        const file = event.target.files[0];
        const reader = new FileReader();
        
        reader.onload = async function (e) {
            await storePrivateKey(e.target.result.trim())
        };
        
        reader.readAsText(file);
    });

    document.getElementById("symmetric-key").addEventListener("change", async (event) => {
        await decryptGlobalAESKey(event.target.value)
    });

    document.getElementById('dataToEncrypt').addEventListener("input", async (event) => {
        const encrypted = await encryptData(event.target.value);
        document.getElementById('encrypted-value').innerHTML = encrypted;
    });

    document.getElementById('decrypt-action').addEventListener('click', async () => {
        const encryptedText = document.getElementById('encrypted-value').innerHTML;

        if (encryptedText.length === 0) {
            console.log('Insert data before decrypt')
            return;
        }

        document.getElementById('decrypted-value').innerHTML = await decryptData(encryptedText)
    })

    function uint8ArrayToBase64(uint8Array) {
        return btoa(String.fromCharCode(...uint8Array));
    }
    
    function base64ToUint8Array(base64) {
        return new Uint8Array([...atob(base64)].map(c => c.charCodeAt(0)));
    }

    async function decryptedAESKey(AESKey) {
        const privateKey = await getPrivateKey()

        if (!privateKey) {
            return;
        }

        try {
            const decryptedKey = await crypto.subtle.decrypt(
                { name: "RSA-OAEP" },
                await getPrivateKey(),
                base64ToUint8Array(AESKey),
            );

            return new Uint8Array(decryptedKey);
        } catch(e) {
            console.error('decryptedAESKey', e)
        }
    }

    async function encryptData(text) {
        const binaryAESKey = await crypto.subtle.importKey(
            "raw",
            _globalAESKey,
            { name: "AES-GCM" },
            false,
            ["encrypt"]
        );
        const iv = crypto.getRandomValues(new Uint8Array(12));

        const encoder = new TextEncoder();
        const dataBuffer = encoder.encode(text);

        const encryptedData = await crypto.subtle.encrypt(
            { name: "AES-GCM", iv },
            binaryAESKey,
            dataBuffer
        );

        return JSON.stringify({
            iv: uint8ArrayToBase64(iv), 
            data: uint8ArrayToBase64(new Uint8Array(encryptedData)) 
        });
    }


    async function decryptData(encrypted) {
        const binaryAESKey = await crypto.subtle.importKey(
            "raw",
            _globalAESKey,
            { name: "AES-GCM" },
            false,
            ["decrypt"]
        );

        const encryptedData = JSON.parse(encrypted)
        const iv = base64ToUint8Array(encryptedData.iv)
        const dataBuffer = base64ToUint8Array(encryptedData.data)

        try {
            const decryptedBuffer = await crypto.subtle.decrypt(
                { name: "AES-GCM", iv },
                binaryAESKey,
                dataBuffer,
            );

            const decoder = new TextDecoder();
            return decoder.decode(decryptedBuffer);
        } catch (error) {
            console.error("decryptData [decrypt]", error);
            return null;
        }
    }

    async function savePrivateKey(privateKey) {
        const db = await idb.openDB("cryptoDB", 1, { upgrade(db) { db.createObjectStore("keys"); } });
        const tx = db.transaction("keys", "readwrite");
        await tx.objectStore("keys").put(privateKey, "privateKey");
    }

    function decodeBase64PrivateKey(base64) {
        return base64ToUint8Array(base64
            .replace(/-----BEGIN PRIVATE KEY-----/g, "")
            .replace(/-----END PRIVATE KEY-----/g, "")
            .replace(/\n/g, "")
            .replace(/\r/g, "")
        )
    }

    async function storePrivateKey(privateKey) {
        const binaryKey = decodeBase64PrivateKey(privateKey);

        try {
            const importedPrivateKey = await crypto.subtle.importKey(
                "pkcs8",
                binaryKey,
                { name: "RSA-OAEP", hash: "SHA-256" },
                false,
                ["decrypt"]
            );

            await savePrivateKey(importedPrivateKey);
            await decryptGlobalAESKey(document.getElementById("symmetric-key").value)

            console.log("Private Key saved!");
        } catch(e) {
            console.error('storePrivateKey [importKey]', e)
        }
    }

    async function getPrivateKey() {
        const db = await idb.openDB("cryptoDB", 1);
        const tx = db.transaction("keys", "readonly");
        return await tx.objectStore("keys").get("privateKey");
    }
</script>
</html>